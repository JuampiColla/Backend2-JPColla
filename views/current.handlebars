<div class="container">
    <div class="current-header">
        <div class="user-profile">
            <div class="avatar-large">
                {{substring user.first_name 0 1}}{{substring user.last_name 0 1}}
            </div>
            <div class="user-details">
                <h1>{{user.first_name}} {{user.last_name}}</h1>
                <p class="user-subtitle">
                    <span class="role-badge {{#if isAdmin}}admin{{else}}user{{/if}}">
                        {{#if isAdmin}}üëë Administrador{{else}}üë§ Usuario{{/if}}
                    </span>
                </p>
            </div>
        </div>
        <button id="logoutBtn" class="btn-secondary">Cerrar Sesi√≥n</button>
        <a href="/products" class="btn-primary">‚Üê Volver a Productos</a>
    </div>

    <div class="current-content">
        <div class="info-section">
            <h2>üìã Informaci√≥n del Perfil</h2>
            
            <div class="info-grid">
                <div class="info-item">
                    <span class="info-label">Email:</span>
                    <span class="info-value">{{user.email}}</span>
                </div>

                <div class="info-item">
                    <span class="info-label">Nombre:</span>
                    <span class="info-value">{{user.first_name}}</span>
                </div>

                <div class="info-item">
                    <span class="info-label">Apellido:</span>
                    <span class="info-value">{{user.last_name}}</span>
                </div>

                <div class="info-item">
                    <span class="info-label">Rol:</span>
                    <span class="info-value">{{user.role}}</span>
                </div>
            </div>
        </div>

        {{#if isAdmin}}
        <div class="admin-section">
            <h2>‚öôÔ∏è Panel de Administrador</h2>
            <div class="admin-actions-grid">
                <a href="/products/manage" class="admin-action-card">
                    <span class="action-icon">üì¶</span>
                    <h3>Gestionar Productos</h3>
                    <p>Crear, editar y controlar inventario</p>
                </a>
                
                <div class="admin-action-card" onclick="alert('Funcionalidad en desarrollo')">
                    <span class="action-icon">üë•</span>
                    <h3>Gestionar Usuarios</h3>
                    <p>Ver todos los usuarios del sistema</p>
                </div>
            </div>
        </div>
        {{/if}}

        <div class="purchases-section">
            <h2>üõçÔ∏è Historial de Compras</h2>
            <div id="purchasesContent">
                <p style="text-align: center; color: #999;">Cargando historial...</p>
            </div>
        </div>
    </div>
</div>

<script>
    let currentUserId = null;

    // Obtener usuario actual y cargar historial
    async function loadUserAndPurchases() {
        try {
            // Obtener usuario actual
            const userRes = await fetch('/api/users/current', {
                credentials: 'include'
            });
            
            if (userRes.ok) {
                const userData = await userRes.json();
                console.log('User data:', userData);
                if (userData.user) {
                    currentUserId = userData.user._id || userData.user.id;
                    console.log('Current user ID:', currentUserId);
                    await loadPurchaseHistory();
                }
            } else {
                console.error('Error fetching user:', userRes.status);
                document.getElementById('purchasesContent').innerHTML = '<p style="color: #e74c3c;">Error al cargar usuario</p>';
            }
        } catch (error) {
            console.error('Error obteniendo usuario:', error);
            document.getElementById('purchasesContent').innerHTML = '<p style="color: #e74c3c;">Error: ' + error.message + '</p>';
        }
    }

    // Cargar historial de compras
    async function loadPurchaseHistory() {
        try {
            if (!currentUserId) {
                console.error('No user ID available');
                document.getElementById('purchasesContent').innerHTML = '<p style="color: #999;">No se pudo obtener el usuario</p>';
                return;
            }

            console.log('Fetching tickets for user:', currentUserId);
            const res = await fetch(`/api/carts/${currentUserId}/tickets`, {
                credentials: 'include',
                headers: {
                    'Content-Type': 'application/json'
                }
            });

            console.log('Response status:', res.status);
            const data = await res.json();
            console.log('Tickets response:', data);

            if (!res.ok) {
                document.getElementById('purchasesContent').innerHTML = '<p style="color: #999;">No se pudo cargar el historial: ' + data.message + '</p>';
                return;
            }

            if (!data.tickets || data.tickets.length === 0) {
                document.getElementById('purchasesContent').innerHTML = '<p style="text-align: center; color: #999; padding: 40px;">No tienes compras registradas</p>';
                return;
            }

            let html = '<div class="purchases-grid">';
            data.tickets.forEach(ticket => {
                const date = new Date(ticket.purchaseDate).toLocaleDateString('es-ES');
                const productsHTML = ticket.products.map(p => 
                    `<li>${p.name || 'Producto'} x${p.quantity} - $${p.price}</li>`
                ).join('');
                
                html += `
                    <div class="purchase-card">
                        <div class="purchase-header">
                            <h3>Compra #${ticket.code}</h3>
                            <span class="purchase-status ${ticket.status}">${ticket.status}</span>
                        </div>
                        <div class="purchase-details">
                            <p><strong>Fecha:</strong> ${date}</p>
                            <p><strong>Monto:</strong> $${ticket.amount}</p>
                            <p><strong>Productos:</strong></p>
                            <ul style="margin-top: 5px;">
                                ${productsHTML}
                            </ul>
                        </div>
                    </div>
                `;
            });
            html += '</div>';

            document.getElementById('purchasesContent').innerHTML = html;
        } catch (error) {
            console.error('Error al cargar compras:', error);
            document.getElementById('purchasesContent').innerHTML = '<p style="color: #e74c3c;">Error: ' + error.message + '</p>';
        }
    }

    document.getElementById('logoutBtn').addEventListener('click', async () => {
        try {
            const response = await fetch('/api/users/logout', {
                method: 'POST'
            });

            const data = await response.json();

            if (data.status === 'success') {
                window.location.href = '/users/login';
            }
        } catch (error) {
            console.error('Error al cerrar sesi√≥n:', error);
            alert('Error al cerrar sesi√≥n');
        }
    });

    // Cargar datos cuando el DOM est√© listo
    document.addEventListener('DOMContentLoaded', loadUserAndPurchases);
</script>