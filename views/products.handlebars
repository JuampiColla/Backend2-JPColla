<div class="container">
    <div class="header">
        <div class="welcome-message">
            <div class="user-avatar">
                {{#if user.avatar}}
                <img src="{{user.avatar}}" alt="Avatar" class="avatar-img">
                {{else}}
                <div class="avatar-placeholder">{{substring user.firstName 0 1}}</div>
                {{/if}}
            </div>
            <div>
                <h1>Bienvenido, {{user.firstName}} {{user.lastName}}</h1>
                <p class="user-info">
                    {{#if user.provider}}
                    <span class="provider-badge">
                        {{#if (eq user.provider 'github')}}
                        <svg height="14" width="14" viewBox="0 0 16 16" fill="currentColor">
                            <path d="M8 0C3.58 0 0 3.58 0 8c0 3.54 2.29 6.53 5.47 7.59.4.07.55-.17.55-.38 0-.19-.01-.82-.01-1.49-2.01.37-2.53-.49-2.69-.94-.09-.23-.48-.94-.82-1.13-.28-.15-.68-.52-.01-.53.63-.01 1.08.58 1.23.82.72 1.21 1.87.87 2.33.66.07-.52.28-.87.51-1.07-1.78-.2-3.64-.89-3.64-3.95 0-.87.31-1.59.82-2.15-.08-.2-.36-1.02.08-2.12 0 0 .67-.21 2.2.82.64-.18 1.32-.27 2-.27.68 0 1.36.09 2 .27 1.53-1.04 2.2-.82 2.2-.82.44 1.1.16 1.92.08 2.12.51.56.82 1.27.82 2.15 0 3.07-1.87 3.75-3.65 3.95.29.25.54.73.54 1.48 0 1.07-.01 1.93-.01 2.2 0 .21.15.46.55.38A8.013 8.013 0 0016 8c0-4.42-3.58-8-8-8z"></path>
                        </svg>
                        GitHub
                        {{else}}
                        ğŸ“§ Local
                        {{/if}}
                    </span>
                    {{/if}}
                    Email: {{user.email}} 
                    {{#if user.age}}| Edad: {{user.age}}{{/if}}
                    | Rol: <span class="role-badge {{#if isAdmin}}admin{{else}}user{{/if}}">{{user.role}}</span>
                </p>
            </div>
        </div>
        <div class="header-actions">
            <a href="/cart" class="btn-primary">ğŸ›’ Ver Carrito</a>
            <button id="logoutBtn" class="btn-secondary">Cerrar SesiÃ³n</button>
        </div>
    </div>

    <div class="products-section">
        <h2>CatÃ¡logo de Productos</h2>
        
        {{#if isAdmin}}
        <div class="admin-panel">
            <p class="admin-notice">â­ Tienes permisos de administrador - Puedes gestionar productos</p>
        </div>
        {{/if}}

        <div class="products-grid">
            {{#each products}}
            <div class="product-card">
                <h3>{{this.name}}</h3>
                <div class="product-info">
                    <p class="price">${{this.price}}</p>
                    <p class="stock">
                        {{#if (gt this.stock 5)}}
                        âœ“ En stock: {{this.stock}} unidades
                        {{else if (gt this.stock 0)}}
                        âš ï¸ Pocas unidades: {{this.stock}}
                        {{else}}
                        âœ— Sin stock
                        {{/if}}
                    </p>
                </div>
                {{#if ../isAdmin}}
                <div class="admin-actions">
                    <button class="btn-small btn-edit" data-id="{{this.id}}">âœï¸ Editar</button>
                    <button class="btn-small btn-delete" data-id="{{this.id}}">ğŸ—‘ï¸ Eliminar</button>
                </div>
                {{else}}
                <button class="btn-primary btn-add-cart" data-id="{{this.id}}" {{#unless (gt this.stock 0)}}disabled{{/unless}}>
                    {{#if (gt this.stock 0)}}
                    ğŸ›’ Agregar al Carrito
                    {{else}}
                    No Disponible
                    {{/if}}
                </button>
                {{/if}}
            </div>
            {{/each}}
        </div>
    </div>
</div>

<script>
    document.getElementById('logoutBtn').addEventListener('click', async () => {
        try {
            const response = await fetch('/api/users/logout', {
                method: 'POST',
                credentials: 'include' // Incluir cookies
            });

            const data = await response.json();

            if (data.status === 'success') {
                window.location.href = '/users/login';
            }
        } catch (error) {
            console.error('Error al cerrar sesiÃ³n:', error);
        }
    });

    // Manejar click en "Agregar al Carrito"
    document.querySelectorAll('.btn-add-cart').forEach(btn => {
        btn.addEventListener('click', async (e) => {
            const productId = e.target.dataset.id;
            try {
                const res = await fetch('/api/carts/add', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    credentials: 'include', // Incluir cookies
                    body: JSON.stringify({ productId, quantity: 1 })
                });

                const data = await res.json();

                if (data.status === 'success') {
                    alert('âœ“ Producto agregado al carrito');
                } else {
                    alert('âœ— Error: ' + data.message);
                }
            } catch (error) {
                console.error('Error:', error);
                alert('âœ— Error al agregar al carrito');
            }
        });
    });

    // Funcionalidad de administrador
    {{#if isAdmin}}
    // Eliminar producto
    document.querySelectorAll('.btn-delete').forEach(btn => {
        btn.addEventListener('click', async (e) => {
            const id = e.target.dataset.id;
            if (confirm('Â¿EstÃ¡s seguro de eliminar este producto?')) {
                try {
                    const response = await fetch(`/api/products/${id}`, {
                        method: 'DELETE'
                    });

                    const data = await response.json();

                    if (data.status === 'success') {
                        alert('âœ“ Producto eliminado correctamente');
                        location.reload();
                    } else {
                        alert('âœ— Error: ' + data.message);
                    }
                } catch (error) {
                    console.error('Error al eliminar:', error);
                    alert('âœ— Error al eliminar el producto');
                }
            }
        });
    });

    // Editar producto
    document.querySelectorAll('.btn-edit').forEach(btn => {
        btn.addEventListener('click', (e) => {
            const id = e.target.dataset.id;
            alert('Funcionalidad de ediciÃ³n - Producto ID: ' + id);
        });
    });
    {{/if}}
</script>