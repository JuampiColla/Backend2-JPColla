<div class="container">
    <div class="login-box">
        <h1>游댃 Restablecer Contrase침a</h1>
        <p class="subtitle">Crea una nueva contrase침a segura</p>
        
        <form id="resetPasswordForm">
            <div class="form-group">
                <label for="newPassword">Nueva Contrase침a:</label>
                <input type="password" id="newPassword" name="newPassword" required 
                       placeholder="M칤nimo 8 caracteres"
                       minlength="8">
                <small>Debe contener al menos un n칰mero, una may칰scula y un s칤mbolo</small>
            </div>

            <div class="form-group">
                <label for="confirmPassword">Confirmar Contrase침a:</label>
                <input type="password" id="confirmPassword" name="confirmPassword" required 
                       placeholder="Repite tu contrase침a"
                       minlength="8">
            </div>

            <button type="submit" class="btn-primary">Restablecer Contrase침a</button>
        </form>

        <div id="message" class="message"></div>

        <div class="link-box">
            <p>Recordaste tu contrase침a? <a href="/users/login">Volver al login</a></p>
        </div>
    </div>
</div>

<style>
    .subtitle {
        color: #666;
        margin-bottom: 20px;
        text-align: center;
    }

    small {
        display: block;
        color: #999;
        margin-top: 5px;
        font-size: 0.85em;
    }
</style>

<script>
    document.getElementById('resetPasswordForm').addEventListener('submit', async (e) => {
        e.preventDefault();
        
        const newPassword = document.getElementById('newPassword').value;
        const confirmPassword = document.getElementById('confirmPassword').value;
        const messageDiv = document.getElementById('message');
        
        // Validar que las contrase침as coincidan
        if (newPassword !== confirmPassword) {
            messageDiv.className = 'message error';
            messageDiv.textContent = 'Las contrase침as no coinciden';
            return;
        }
        
        // Validar requisitos de contrase침a
        const passwordRegex = /^(?=.*[a-z])(?=.*[A-Z])(?=.*\d)(?=.*[@$!%*?&])[A-Za-z\d@$!%*?&]{8,}$/;
        if (!passwordRegex.test(newPassword)) {
            messageDiv.className = 'message error';
            messageDiv.textContent = 'La contrase침a debe contener may칰scula, min칰scula, n칰mero y s칤mbolo';
            return;
        }
        
        // Obtener el token de la URL
        const params = new URLSearchParams(window.location.search);
        const token = params.get('token');
        
        if (!token) {
            messageDiv.className = 'message error';
            messageDiv.textContent = 'Enlace inv치lido o expirado';
            return;
        }
        
        try {
            const response = await fetch('/api/password/reset', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ 
                    token,
                    newPassword,
                    confirmPassword
                })
            });
            
            const data = await response.json();
            
            messageDiv.className = response.ok ? 'message success' : 'message error';
            messageDiv.textContent = data.message || 'Contrase침a restablecida exitosamente';
            
            if (response.ok) {
                document.getElementById('resetPasswordForm').reset();
                setTimeout(() => {
                    window.location.href = '/users/login';
                }, 2000);
            }
        } catch (error) {
            messageDiv.className = 'message error';
            messageDiv.textContent = 'Error al restablecer contrase침a';
        }
    });
</script>
